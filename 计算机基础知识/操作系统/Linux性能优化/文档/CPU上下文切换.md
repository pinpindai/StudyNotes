[toc]

### 什么是CPU上下文

>   cpu上下文是指cpu运行任何任务前，必须的依赖环境，包括cpu寄存器和程序计数器
>
>   cpu寄存器，是cpu内置的容量小、但速度极快的内存
>
>   程序计数器（PC）是用来存储cpu正在执行的指令位置、或者即将执行的下一条指令位置
>
>   cpu上下文切换是保证系统正常工作的核心功能，但是过多的上下文切换，会把cpu时间消耗在寄存器、内核栈以及虚拟内存等数据的保存和恢复上

### CPU上下文切换

>   cpu上下文切换就是指，先把前一个任务的cpu上下文保存到系统内核中，然后，加载新任务的上下文到这些寄存器和程序计数器，最后再跳转到程序计数器所指的新位置，运行新任务。当前一个任务被重新调度执行时，再从系统内核加载进来保存的cpu上下文，这样就能保证任务原来的状态不受影响，让任务看起来还是连续运行的。 

### cpu上下文切换的场景

>   *   进程上下文切换
>   *   线程上下文切换
>   *   中断上下文切换

### 系统调用

>   进程的运行空间分为内核空间和用户空间（CPU特权等级分别为Ring0和Ring1）
>
>   内核空间具有最高的权限，可以直接访问所有资源
>
>   用户空间只能访问受限资源，不能直接访问内存等硬件设备，必须通过系统调用陷入到内核中，才能访问到这些特权资源
>
>   进程通过系统调用，从用户态转变为内核态，一次系统调用会发生两次CPU上下文切换
>
>   系统调用和进程上下文切换的区别：进程上下文切换时从一个进程切换到另一个进程，系统调用过程是一直是同一个进程中在运行

### 进程的上下文切换

>   进程是由内核来管理和调度的，进程的切换只能发生在内核态，所以进程的上下文切换不仅包含虚拟内存、栈、全局变量等用户空间的资源，还包括内核堆栈、寄存器等内核空间的状态



>   进程切换的场景：
>
>   *   进程的cpu时间片耗尽（为保证公平调度，cpu时间被划分为时间片，轮流分配给各进程），被系统挂起，切换到其他等待cpu的进程运行
>   *   进程需要的系统资源不足，被挂起（等待需要的资源被满足后，才可以运行）
>   *   进程通过睡眠函数sleep，将自己主动挂起
>   *   当高优先级进程需要运行时，当前进程被挂起
>   *   发生硬中断时，进程被挂起，cpu转去执行中断服务



### 线程的上下文切换

>   进程与线程的最大区别：线程是调度的基本单位，进程时资源拥有的基本单位
>
>   进程拥有多个线程时，各个线程之间共享虚拟内存和全局变量等资源，这些在线程切换时不需要修改
>
>   线程自己的私有数据，如栈和寄存器等，在上下文切换时，需要保存



>   线程的上下文切换分两种情况：
>
>   *   前后两个线程属于不同进程，这时线程切换等同于进程切换
>   *   前后两个线程同属于同一个进程，切换时，虚拟内存、全局变量等资源不动，只需要切换线程的私有数据（栈、寄存器等）



### 中断的上下文切换

>   为了快速响应硬件的事件，中断处理会打断进程的正常调度与执行（中断处理比进程优先级高）
>
>   中断切换不涉及进程的用户态，中断上下文只包括内核中断服务程序执行所必须的状态（cpu寄存器、内核堆栈、硬件中断参数等）